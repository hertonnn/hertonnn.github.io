<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Verificador de Aten√ß√£o</title>
  <style>
    html, body {
      margin: 0; padding: 0; background: #fff;
      height: 100%; overflow: hidden; font-family: sans-serif;
    }

    /* Imagem do p√°ssaro atr√°s de tudo */
    #bird {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      max-width: 80vw; max-height: 80vh; z-index: 1;
    }

    /* Pop-up (sem transition de height) */
    #popup {
      position: absolute; top: 20px; left: 20px;
      width: 240px; height: 180px;
      background: #f0f0f0; border: 1px solid rgba(0,0,0,0.2);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2); border-radius: 6px;
      display: flex; flex-direction: column; user-select: none; z-index: 10;
      /* transition: height 0.2s ease;  ‚Üê removido */
    }
    #popup-header {
      background: #444; color: #fff;
      padding: 4px 8px; cursor: move;
      display: flex; justify-content: space-between; align-items: center;
      border-top-left-radius: 6px; border-top-right-radius: 6px;
    }
    #popup-header button {
      background: transparent; border: none; color: #fff; font-size: 14px; cursor: pointer;
    }
    #popup-content {
      position: relative; flex: 1; background: #000; overflow: hidden;
    }
    #resizer {
      width: 10px; height: 10px; background: #444;
      position: absolute; right: 2px; bottom: 2px;
      cursor: nwse-resize; border-radius: 2px;
    }

    /* V√≠deo + Canvas */
    #video, #overlay {
      position: absolute; top: 0; left: 0;
    }

    /* Contador */
    #counter {
      position: absolute; top: 4px; left: 8px;
      font-size: 12px; background: rgba(255,255,255,0.8);
      padding: 2px 4px; border-radius: 4px; z-index: 5;
    }
  </style>
</head>
<body>

  <img id="bird" src="fotos_passaros/bird1.png" alt="P√°ssaro" />

  <div id="popup">
    <div id="popup-header">
      <span>Debug Webcam</span>
      <button id="min-btn">_</button>
    </div>
    <div id="popup-content">
      <video id="video" autoplay muted></video>
      <canvas id="overlay"></canvas>
      <div id="counter">0</div>
      <div id="resizer"></div>
    </div>
  </div>

  <audio id="bird-audio" src="audios_passaros/song.mp3" loop></audio>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script>
    window.addEventListener('DOMContentLoaded', async () => {
      const popup     = document.getElementById('popup');
      const header    = document.getElementById('popup-header');
      const content   = document.getElementById('popup-content');
      const resizer   = document.getElementById('resizer');
      const minBtn    = document.getElementById('min-btn');
      const video     = document.getElementById('video');
      const canvas    = document.getElementById('overlay');
      const counterEl = document.getElementById('counter');
      const birdAudio = document.getElementById('bird-audio');

      let counter = 0, detectionInterval = null, minimized = false;

      await faceapi.nets.ssdMobilenetv1.loadFromUri(
        'https://justadudewhohacks.github.io/face-api.js/models/'
      );

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (e) {
        console.error("Webcam indispon√≠vel:", e);
        return;
      }

      function resizeVideoCanvas() {
        const w = content.clientWidth, h = content.clientHeight;
        video.style.width  = w + 'px';
        video.style.height = h + 'px';
        canvas.width  = w;
        canvas.height = h;
        faceapi.matchDimensions(canvas, { width: w, height: h });
      }

      function startDetection() {
        if (detectionInterval) return;
        detectionInterval = setInterval(async () => {
          if (minimized) return;
          const w = canvas.width, h = canvas.height;
          const detections = await faceapi.detectAllFaces(
            video,
            new faceapi.SsdMobilenetv1Options({ minConfidence: 0 })
          );
          const resized = faceapi.resizeResults(detections, { width: w, height: h });
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, w, h);
          faceapi.draw.drawDetections(canvas, resized);

          if (resized.length === 0) {
            counter++;
            counterEl.textContent = counter;
            if (birdAudio.paused) {
              birdAudio.currentTime = 0;
              birdAudio.play();
            }
          } else if (!birdAudio.paused) {
            birdAudio.pause();
            birdAudio.currentTime = 0;
          }
        }, 1000);
      }

      function stopDetection() {
        clearInterval(detectionInterval);
        detectionInterval = null;
      }

      video.addEventListener('play', () => {
        resizeVideoCanvas();
        startDetection();
      });

      window.addEventListener('resize', resizeVideoCanvas);

      // drag
      header.addEventListener('mousedown', e => {
        const shiftX = e.clientX - popup.offsetLeft;
        const shiftY = e.clientY - popup.offsetTop;
        function move(e) {
          popup.style.left = (e.clientX - shiftX) + 'px';
          popup.style.top  = (e.clientY - shiftY) + 'px';
        }
        document.addEventListener('mousemove', move);
        document.addEventListener('mouseup', () => document.removeEventListener('mousemove', move), { once: true });
      });

      // resize
      resizer.addEventListener('mousedown', e => {
        e.preventDefault();
        const startX = e.clientX, startY = e.clientY;
        const startW = popup.offsetWidth, startH = popup.offsetHeight;
        function move(e) {
          popup.style.width  = (startW + e.clientX - startX) + 'px';
          popup.style.height = (startH + e.clientY - startY) + 'px';
          resizeVideoCanvas();
        }
        document.addEventListener('mousemove', move);
        document.addEventListener('mouseup', () => document.removeEventListener('mousemove', move), { once: true });
      });

      // minimizar/restaurar
      minBtn.addEventListener('click', () => {
        minimized = !minimized;
        if (minimized) {
          content.style.display = 'none';
          popup.style.height    = header.offsetHeight + 'px';
          stopDetection();
          minBtn.textContent    = 'üîº';
        } else {
          content.style.display = 'block';
          popup.style.height    = '';
          resizeVideoCanvas();
          startDetection();
          minBtn.textContent    = '_';
        }
      });
    });
  </script>
</body>
</html>
